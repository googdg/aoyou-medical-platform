<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°é¬¼æ¶ˆæ¶ˆä¹ - åŠŸèƒ½æµ‹è¯•</title>
    <link rel="stylesheet" href="css/ghost-match3.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
        }
        .test-title {
            color: #667eea;
            margin-bottom: 15px;
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
        }
        .test-pass {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .test-fail {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .test-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .game-test-container {
            width: 400px;
            height: 500px;
            margin: 20px auto;
            border: 2px solid #667eea;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>å°é¬¼æ¶ˆæ¶ˆä¹ - åŠŸèƒ½æµ‹è¯•</h1>
        <p>è¿™ä¸ªé¡µé¢ç”¨äºæµ‹è¯•æ¸¸æˆçš„å„ä¸ªç»„ä»¶æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚</p>

        <!-- æ¨¡å—åŠ è½½æµ‹è¯• -->
        <div class="test-section">
            <h2 class="test-title">1. æ¨¡å—åŠ è½½æµ‹è¯•</h2>
            <div id="module-test-results"></div>
        </div>

        <!-- ç½‘æ ¼ç®¡ç†å™¨æµ‹è¯• -->
        <div class="test-section">
            <h2 class="test-title">2. ç½‘æ ¼ç®¡ç†å™¨æµ‹è¯•</h2>
            <div id="grid-test-results"></div>
        </div>

        <!-- å°é¬¼ç®¡ç†å™¨æµ‹è¯• -->
        <div class="test-section">
            <h2 class="test-title">3. å°é¬¼ç®¡ç†å™¨æµ‹è¯•</h2>
            <div id="ghost-test-results"></div>
        </div>

        <!-- æ¸¸æˆå¼•æ“æµ‹è¯• -->
        <div class="test-section">
            <h2 class="test-title">4. æ¸¸æˆå¼•æ“æµ‹è¯•</h2>
            <div id="engine-test-results"></div>
            <div class="game-test-container" id="game-test-container"></div>
        </div>

        <!-- æ€§èƒ½æµ‹è¯• -->
        <div class="test-section">
            <h2 class="test-title">5. æ€§èƒ½æµ‹è¯•</h2>
            <div id="performance-test-results"></div>
        </div>
    </div>

    <!-- åŠ è½½æ¸¸æˆæ¨¡å— -->
    <script src="js/grid-manager.js"></script>
    <script src="js/ghost-manager.js"></script>
    <script src="js/ghost-match3-engine.js"></script>

    <script>
        // æµ‹è¯•ç»“æœè®°å½•
        const testResults = {
            modules: [],
            grid: [],
            ghost: [],
            engine: [],
            performance: []
        };

        /**
         * æ·»åŠ æµ‹è¯•ç»“æœ
         */
        function addTestResult(category, testName, passed, message = '') {
            testResults[category].push({
                name: testName,
                passed: passed,
                message: message,
                timestamp: new Date().toISOString()
            });
        }

        /**
         * æ˜¾ç¤ºæµ‹è¯•ç»“æœ
         */
        function displayTestResults(category, containerId) {
            const container = document.getElementById(containerId);
            const results = testResults[category];
            
            let html = '';
            results.forEach(result => {
                const cssClass = result.passed ? 'test-pass' : 'test-fail';
                const status = result.passed ? 'âœ… PASS' : 'âŒ FAIL';
                html += `
                    <div class="${cssClass} test-result">
                        <strong>${status}</strong> ${result.name}
                        ${result.message ? `<br>è¯¦æƒ…: ${result.message}` : ''}
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        /**
         * æ¨¡å—åŠ è½½æµ‹è¯•
         */
        function testModuleLoading() {
            console.log('å¼€å§‹æ¨¡å—åŠ è½½æµ‹è¯•...');
            
            // æµ‹è¯• GridManager ç±»æ˜¯å¦å­˜åœ¨
            try {
                const hasGridManager = typeof GridManager !== 'undefined';
                addTestResult('modules', 'GridManager ç±»åŠ è½½', hasGridManager, 
                    hasGridManager ? 'GridManager ç±»å·²æˆåŠŸåŠ è½½' : 'GridManager ç±»æœªæ‰¾åˆ°');
            } catch (error) {
                addTestResult('modules', 'GridManager ç±»åŠ è½½', false, error.message);
            }

            // æµ‹è¯• GhostManager ç±»æ˜¯å¦å­˜åœ¨
            try {
                const hasGhostManager = typeof GhostManager !== 'undefined';
                addTestResult('modules', 'GhostManager ç±»åŠ è½½', hasGhostManager,
                    hasGhostManager ? 'GhostManager ç±»å·²æˆåŠŸåŠ è½½' : 'GhostManager ç±»æœªæ‰¾åˆ°');
            } catch (error) {
                addTestResult('modules', 'GhostManager ç±»åŠ è½½', false, error.message);
            }

            // æµ‹è¯• GhostMatch3Engine ç±»æ˜¯å¦å­˜åœ¨
            try {
                const hasEngine = typeof GhostMatch3Engine !== 'undefined';
                addTestResult('modules', 'GhostMatch3Engine ç±»åŠ è½½', hasEngine,
                    hasEngine ? 'GhostMatch3Engine ç±»å·²æˆåŠŸåŠ è½½' : 'GhostMatch3Engine ç±»æœªæ‰¾åˆ°');
            } catch (error) {
                addTestResult('modules', 'GhostMatch3Engine ç±»åŠ è½½', false, error.message);
            }

            displayTestResults('modules', 'module-test-results');
        }

        /**
         * ç½‘æ ¼ç®¡ç†å™¨æµ‹è¯•
         */
        function testGridManager() {
            console.log('å¼€å§‹ç½‘æ ¼ç®¡ç†å™¨æµ‹è¯•...');
            
            try {
                // åˆ›å»ºç½‘æ ¼ç®¡ç†å™¨å®ä¾‹
                const gridManager = new GridManager({ width: 8, height: 8 });
                addTestResult('grid', 'ç½‘æ ¼ç®¡ç†å™¨å®ä¾‹åŒ–', true, '8x8 ç½‘æ ¼åˆ›å»ºæˆåŠŸ');

                // æµ‹è¯•ç½‘æ ¼åˆå§‹åŒ–
                const isEmpty = gridManager.grid.every(row => row.every(cell => cell === null));
                addTestResult('grid', 'ç½‘æ ¼åˆå§‹åŒ–', isEmpty, 'ç½‘æ ¼å·²æ­£ç¡®åˆå§‹åŒ–ä¸ºç©º');

                // æµ‹è¯•ä½ç½®éªŒè¯
                const validPos = gridManager.isValidPosition(3, 3);
                const invalidPos = gridManager.isValidPosition(10, 10);
                addTestResult('grid', 'ä½ç½®éªŒè¯', validPos && !invalidPos, 
                    `æœ‰æ•ˆä½ç½®æ£€æµ‹: ${validPos}, æ— æ•ˆä½ç½®æ£€æµ‹: ${!invalidPos}`);

                // æµ‹è¯•ç“¦ç‰‡è®¾ç½®å’Œè·å–
                const testTile = { type: 0, id: 'test' };
                gridManager.setTile(3, 3, testTile);
                const retrievedTile = gridManager.getTile(3, 3);
                addTestResult('grid', 'ç“¦ç‰‡è®¾ç½®å’Œè·å–', retrievedTile === testTile,
                    'ç“¦ç‰‡è®¾ç½®å’Œè·å–åŠŸèƒ½æ­£å¸¸');

                // æµ‹è¯•ç“¦ç‰‡äº¤æ¢
                const testTile2 = { type: 1, id: 'test2' };
                gridManager.setTile(3, 4, testTile2);
                gridManager.swapTiles({ x: 3, y: 3 }, { x: 3, y: 4 });
                const swapped1 = gridManager.getTile(3, 3);
                const swapped2 = gridManager.getTile(3, 4);
                addTestResult('grid', 'ç“¦ç‰‡äº¤æ¢', swapped1 === testTile2 && swapped2 === testTile,
                    'ç“¦ç‰‡äº¤æ¢åŠŸèƒ½æ­£å¸¸');

            } catch (error) {
                addTestResult('grid', 'ç½‘æ ¼ç®¡ç†å™¨æµ‹è¯•', false, error.message);
            }

            displayTestResults('grid', 'grid-test-results');
        }

        /**
         * å°é¬¼ç®¡ç†å™¨æµ‹è¯•
         */
        function testGhostManager() {
            console.log('å¼€å§‹å°é¬¼ç®¡ç†å™¨æµ‹è¯•...');
            
            try {
                // åˆ›å»ºå°é¬¼ç®¡ç†å™¨å®ä¾‹
                const ghostManager = new GhostManager(6);
                addTestResult('ghost', 'å°é¬¼ç®¡ç†å™¨å®ä¾‹åŒ–', true, '6ç§å°é¬¼ç±»å‹åˆå§‹åŒ–æˆåŠŸ');

                // æµ‹è¯•å°é¬¼ç±»å‹åˆå§‹åŒ–
                const hasGhostTypes = ghostManager.ghostTypes.length === 6;
                addTestResult('ghost', 'å°é¬¼ç±»å‹åˆå§‹åŒ–', hasGhostTypes,
                    `å°é¬¼ç±»å‹æ•°é‡: ${ghostManager.ghostTypes.length}`);

                // æµ‹è¯•éšæœºå°é¬¼åˆ›å»º
                const randomGhost = ghostManager.createRandomGhost();
                const isValidGhost = randomGhost && typeof randomGhost.type === 'number' && 
                                   randomGhost.type >= 0 && randomGhost.type < 6;
                addTestResult('ghost', 'éšæœºå°é¬¼åˆ›å»º', isValidGhost,
                    `åˆ›å»ºçš„å°é¬¼ç±»å‹: ${randomGhost ? randomGhost.type : 'null'}`);

                // æµ‹è¯•ç‰¹æ®Šå°é¬¼åˆ›å»º
                const specialGhost = ghostManager.createSpecialGhost('bomb');
                const isValidSpecial = specialGhost && specialGhost.isSpecial && 
                                     specialGhost.specialType === 'bomb';
                addTestResult('ghost', 'ç‰¹æ®Šå°é¬¼åˆ›å»º', isValidSpecial,
                    `ç‰¹æ®Šå°é¬¼ç±»å‹: ${specialGhost ? specialGhost.specialType : 'null'}`);

                // æµ‹è¯•å°é¬¼IDç”Ÿæˆ
                const ghost1 = ghostManager.createRandomGhost();
                const ghost2 = ghostManager.createRandomGhost();
                const uniqueIds = ghost1.id !== ghost2.id;
                addTestResult('ghost', 'å°é¬¼IDå”¯ä¸€æ€§', uniqueIds,
                    `ID1: ${ghost1.id.substring(0, 10)}..., ID2: ${ghost2.id.substring(0, 10)}...`);

            } catch (error) {
                addTestResult('ghost', 'å°é¬¼ç®¡ç†å™¨æµ‹è¯•', false, error.message);
            }

            displayTestResults('ghost', 'ghost-test-results');
        }

        /**
         * æ¸¸æˆå¼•æ“æµ‹è¯•
         */
        function testGameEngine() {
            console.log('å¼€å§‹æ¸¸æˆå¼•æ“æµ‹è¯•...');
            
            try {
                const container = document.getElementById('game-test-container');
                
                // åˆ›å»ºæ¸¸æˆå¼•æ“å®ä¾‹
                const gameEngine = new GhostMatch3Engine(container, {
                    gridSize: { width: 8, height: 8 },
                    ghostTypes: 6
                });
                
                addTestResult('engine', 'æ¸¸æˆå¼•æ“å®ä¾‹åŒ–', true, 'æ¸¸æˆå¼•æ“åˆ›å»ºæˆåŠŸ');

                // æµ‹è¯•æ¸¸æˆçŠ¶æ€åˆå§‹åŒ–
                const hasGameState = gameEngine.gameState && 
                                   typeof gameEngine.gameState.score === 'number';
                addTestResult('engine', 'æ¸¸æˆçŠ¶æ€åˆå§‹åŒ–', hasGameState,
                    `åˆå§‹åˆ†æ•°: ${gameEngine.gameState.score}`);

                // æµ‹è¯•äº‹ä»¶ç³»ç»Ÿ
                let eventFired = false;
                gameEngine.on('testEvent', () => { eventFired = true; });
                gameEngine.emit('testEvent');
                addTestResult('engine', 'äº‹ä»¶ç³»ç»Ÿ', eventFired, 'äº‹ä»¶å‘å°„å’Œç›‘å¬æ­£å¸¸');

                // æµ‹è¯•UIåˆ›å»º
                const hasGameBoard = container.querySelector('.game-board') !== null;
                addTestResult('engine', 'UIç•Œé¢åˆ›å»º', hasGameBoard, 'æ¸¸æˆç•Œé¢å·²åˆ›å»º');

                // æµ‹è¯•æ¸¸æˆæ§åˆ¶
                gameEngine.startNewGame();
                const gameStarted = gameEngine.isGameActive;
                addTestResult('engine', 'æ¸¸æˆå¼€å§‹æ§åˆ¶', gameStarted, 'æ¸¸æˆå¼€å§‹åŠŸèƒ½æ­£å¸¸');

                // æ¸…ç†æµ‹è¯•
                setTimeout(() => {
                    gameEngine.destroy();
                    addTestResult('engine', 'æ¸¸æˆå¼•æ“æ¸…ç†', true, 'æ¸¸æˆå¼•æ“å·²æ¸…ç†');
                    displayTestResults('engine', 'engine-test-results');
                }, 100);

            } catch (error) {
                addTestResult('engine', 'æ¸¸æˆå¼•æ“æµ‹è¯•', false, error.message);
                displayTestResults('engine', 'engine-test-results');
            }
        }

        /**
         * æ€§èƒ½æµ‹è¯•
         */
        function testPerformance() {
            console.log('å¼€å§‹æ€§èƒ½æµ‹è¯•...');
            
            try {
                // æµ‹è¯•å¤§é‡å°é¬¼åˆ›å»ºæ€§èƒ½
                const startTime = performance.now();
                const ghostManager = new GhostManager(6);
                const ghosts = [];
                
                for (let i = 0; i < 1000; i++) {
                    ghosts.push(ghostManager.createRandomGhost());
                }
                
                const endTime = performance.now();
                const duration = endTime - startTime;
                
                addTestResult('performance', 'å¤§é‡å°é¬¼åˆ›å»º', duration < 100,
                    `åˆ›å»º1000ä¸ªå°é¬¼è€—æ—¶: ${duration.toFixed(2)}ms`);

                // æµ‹è¯•ç½‘æ ¼æ“ä½œæ€§èƒ½
                const gridStartTime = performance.now();
                const gridManager = new GridManager({ width: 10, height: 10 });
                
                for (let i = 0; i < 100; i++) {
                    gridManager.setTile(i % 10, Math.floor(i / 10), { type: i % 6 });
                }
                
                const gridEndTime = performance.now();
                const gridDuration = gridEndTime - gridStartTime;
                
                addTestResult('performance', 'ç½‘æ ¼æ“ä½œ', gridDuration < 50,
                    `100æ¬¡ç½‘æ ¼æ“ä½œè€—æ—¶: ${gridDuration.toFixed(2)}ms`);

                // å†…å­˜ä½¿ç”¨æµ‹è¯•
                const memoryInfo = performance.memory ? {
                    used: Math.round(performance.memory.usedJSHeapSize / 1024 / 1024),
                    total: Math.round(performance.memory.totalJSHeapSize / 1024 / 1024)
                } : null;
                
                if (memoryInfo) {
                    addTestResult('performance', 'å†…å­˜ä½¿ç”¨', memoryInfo.used < 50,
                        `å½“å‰å†…å­˜ä½¿ç”¨: ${memoryInfo.used}MB / ${memoryInfo.total}MB`);
                } else {
                    addTestResult('performance', 'å†…å­˜ä½¿ç”¨', true, 'å†…å­˜ä¿¡æ¯ä¸å¯ç”¨ï¼ˆéChromeæµè§ˆå™¨ï¼‰');
                }

            } catch (error) {
                addTestResult('performance', 'æ€§èƒ½æµ‹è¯•', false, error.message);
            }

            displayTestResults('performance', 'performance-test-results');
        }

        /**
         * è¿è¡Œæ‰€æœ‰æµ‹è¯•
         */
        function runAllTests() {
            console.log('å¼€å§‹è¿è¡Œæ‰€æœ‰æµ‹è¯•...');
            
            // æŒ‰é¡ºåºè¿è¡Œæµ‹è¯•
            testModuleLoading();
            
            setTimeout(() => {
                testGridManager();
                testGhostManager();
                testGameEngine();
                testPerformance();
                
                // æ˜¾ç¤ºæµ‹è¯•æ€»ç»“
                setTimeout(() => {
                    showTestSummary();
                }, 200);
            }, 100);
        }

        /**
         * æ˜¾ç¤ºæµ‹è¯•æ€»ç»“
         */
        function showTestSummary() {
            const allResults = Object.values(testResults).flat();
            const totalTests = allResults.length;
            const passedTests = allResults.filter(r => r.passed).length;
            const failedTests = totalTests - passedTests;
            
            const summaryHtml = `
                <div class="test-info test-result">
                    <strong>ğŸ“Š æµ‹è¯•æ€»ç»“</strong><br>
                    æ€»æµ‹è¯•æ•°: ${totalTests}<br>
                    é€šè¿‡: ${passedTests}<br>
                    å¤±è´¥: ${failedTests}<br>
                    æˆåŠŸç‡: ${((passedTests / totalTests) * 100).toFixed(1)}%
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', summaryHtml);
            
            console.log(`æµ‹è¯•å®Œæˆ - é€šè¿‡: ${passedTests}/${totalTests}`);
        }

        // é¡µé¢åŠ è½½å®Œæˆåè¿è¡Œæµ‹è¯•
        document.addEventListener('DOMContentLoaded', function() {
            console.log('å°é¬¼æ¶ˆæ¶ˆä¹æµ‹è¯•é¡µé¢åŠ è½½å®Œæˆ');
            runAllTests();
        });
    </script>
</body>
</html>