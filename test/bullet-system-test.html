<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­å¼¹ç³»ç»Ÿæµ‹è¯• - Bullet System Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f0f0f0;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .test-pass {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .test-fail {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        #bulletCanvas {
            border: 2px solid #333;
            background: #000;
        }
        .controls {
            margin: 10px 0;
        }
        .bullet-info {
            background: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .bullet-types {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 10px 0;
        }
        .bullet-sample {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }
        .bullet-color {
            width: 20px;
            height: 20px;
            border: 1px solid #333;
            border-radius: 50%;
        }
    </style>
</head>
<body>
    <h1>ğŸ’¥ å­å¼¹ç³»ç»Ÿæµ‹è¯•</h1>
    
    <div class="test-container">
        <h2>ğŸ“‹ æµ‹è¯•ç»“æœ</h2>
        <div id="testResults"></div>
        <button onclick="runAllTests()">ğŸš€ è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
        <button onclick="clearResults()">ğŸ§¹ æ¸…é™¤ç»“æœ</button>
    </div>

    <div class="test-container">
        <h2>ğŸ® å­å¼¹å¯è§†åŒ–æµ‹è¯•</h2>
        <canvas id="bulletCanvas" width="800" height="600"></canvas>
        <div class="controls">
            <button onclick="fireBullet('normal')">ğŸ’¥ æ™®é€šå­å¼¹</button>
            <button onclick="fireBullet('armor_piercing')">ğŸ”« ç©¿ç”²å¼¹</button>
            <button onclick="fireBullet('explosive')">ğŸ’£ çˆ†ç‚¸å¼¹</button>
            <button onclick="fireBullet('laser')">âš¡ æ¿€å…‰</button>
            <button onclick="fireBullet('plasma')">ğŸŒŸ ç­‰ç¦»å­å¼¹</button>
        </div>
        <div class="controls">
            <button onclick="createExplosion()">ğŸ’¥ åˆ›å»ºçˆ†ç‚¸</button>
            <button onclick="testPenetration()">ğŸ¯ æµ‹è¯•ç©¿é€</button>
            <button onclick="testTrail()">âœ¨ æµ‹è¯•è½¨è¿¹</button>
            <button onclick="clearBullets()">ğŸ§¹ æ¸…é™¤å­å¼¹</button>
        </div>
        <div class="controls">
            <p><strong>è¯´æ˜ï¼š</strong> ç‚¹å‡»ç”»å¸ƒå‘å°„å­å¼¹åˆ°é¼ æ ‡ä½ç½®</p>
        </div>
    </div>

    <div class="test-container">
        <h2>ğŸ“Š å­å¼¹ä¿¡æ¯</h2>
        <div class="bullet-info" id="bulletInfo">
            <p>æ´»è·ƒå­å¼¹: <span id="activeBullets">0</span></p>
            <p>å¯¹è±¡æ± : <span id="pooledBullets">0</span></p>
            <p>çˆ†ç‚¸æ•ˆæœ: <span id="explosions">0</span></p>
        </div>
        
        <h3>å­å¼¹ç±»å‹</h3>
        <div class="bullet-types">
            <div class="bullet-sample">
                <div class="bullet-color" style="background: #FFD700;"></div>
                <span>æ™®é€šå­å¼¹</span>
            </div>
            <div class="bullet-sample">
                <div class="bullet-color" style="background: #C0C0C0;"></div>
                <span>ç©¿ç”²å¼¹</span>
            </div>
            <div class="bullet-sample">
                <div class="bullet-color" style="background: #FF4500;"></div>
                <span>çˆ†ç‚¸å¼¹</span>
            </div>
            <div class="bullet-sample">
                <div class="bullet-color" style="background: #FF0000;"></div>
                <span>æ¿€å…‰</span>
            </div>
            <div class="bullet-sample">
                <div class="bullet-color" style="background: #00FFFF;"></div>
                <span>ç­‰ç¦»å­å¼¹</span>
            </div>
        </div>
    </div>

    <!-- å¼•å…¥ä¾èµ– -->
    <script src="../js/entity-component-system.js"></script>
    <script src="../js/map-system.js"></script>
    <script src="../js/tank-system.js"></script>
    <script src="../js/bullet-system.js"></script>
    
    <script>
        // æµ‹è¯•ç®¡ç†å™¨
        class BulletTestManager {
            constructor() {
                this.results = [];
                this.entityManager = new ECS.EntityManager();
                this.fireSystem = new BulletSystem.FireSystem();
                this.canvas = document.getElementById('bulletCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.ctx.imageSmoothingEnabled = false;
                
                // è®¾ç½®å…¨å±€å¼•ç”¨
                window.game = {
                    entityManager: this.entityManager,
                    canvas: this.canvas,
                    currentMap: null,
                    createExplosion: (x, y, radius) => this.createExplosion(x, y, radius)
                };
                
                this.mousePos = { x: 400, y: 300 };
                this.initInput();
                this.startRenderLoop();
            }

            initInput() {
                this.canvas.addEventListener('mousemove', (e) => {
                    const rect = this.canvas.getBoundingClientRect();
                    this.mousePos.x = e.clientX - rect.left;
                    this.mousePos.y = e.clientY - rect.top;
                });
                
                this.canvas.addEventListener('click', (e) => {
                    const rect = this.canvas.getBoundingClientRect();
                    const targetX = e.clientX - rect.left;
                    const targetY = e.clientY - rect.top;
                    this.fireToTarget(targetX, targetY);
                });
            }

            fireToTarget(targetX, targetY) {
                const startX = this.canvas.width / 2;
                const startY = this.canvas.height - 50;
                
                const dx = targetX - startX;
                const dy = targetY - startY;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                const speed = 300;
                const velocityX = (dx / distance) * speed;
                const velocityY = (dy / distance) * speed;
                
                this.createBullet({
                    x: startX,
                    y: startY,
                    velocityX: velocityX,
                    velocityY: velocityY,
                    type: BulletSystem.BulletType.NORMAL
                });
            }

            createBullet(bulletData) {
                const bullet = this.fireSystem.createBullet(bulletData);
                this.entityManager.addEntity(bullet);
                
                // ç®€å•çš„è¾¹ç•Œæ£€æŸ¥
                const originalUpdate = bullet.update.bind(bullet);
                bullet.update = (deltaTime) => {
                    originalUpdate(deltaTime);
                    
                    const transform = bullet.getComponent('Transform');
                    if (transform) {
                        if (transform.x < -50 || transform.x > this.canvas.width + 50 ||
                            transform.y < -50 || transform.y > this.canvas.height + 50) {
                            this.entityManager.removeEntity(bullet);
                        }
                    }
                };
                
                return bullet;
            }

            createExplosion(x, y, radius = 50) {
                const explosion = new ECS.Entity('Explosion');
                
                explosion.addComponent(new ECS.Transform(x, y, 0));
                explosion.addComponent(new BulletSystem.Explosion(radius, 1000));
                explosion.addComponent(new BulletSystem.ExplosionRenderer());
                
                explosion.addTag('explosion');
                explosion.addTag('effect');
                
                this.entityManager.addEntity(explosion);
                return explosion;
            }

            // æ·»åŠ æµ‹è¯•ç»“æœ
            addResult(testName, passed, message = '') {
                this.results.push({
                    name: testName,
                    passed: passed,
                    message: message,
                    timestamp: new Date().toLocaleTimeString()
                });
                this.updateResultsDisplay();
            }

            // æ›´æ–°ç»“æœæ˜¾ç¤º
            updateResultsDisplay() {
                const container = document.getElementById('testResults');
                container.innerHTML = '';
                
                this.results.forEach(result => {
                    const div = document.createElement('div');
                    div.className = `test-result ${result.passed ? 'test-pass' : 'test-fail'}`;
                    div.innerHTML = `
                        <strong>${result.passed ? 'âœ…' : 'âŒ'} ${result.name}</strong>
                        <br><small>${result.timestamp}</small>
                        ${result.message ? `<br>${result.message}` : ''}
                    `;
                    container.appendChild(div);
                });
            }

            // æ¸…é™¤ç»“æœ
            clearResults() {
                this.results = [];
                this.updateResultsDisplay();
            }

            // å¼€å§‹æ¸²æŸ“å¾ªç¯
            startRenderLoop() {
                const render = () => {
                    this.update();
                    this.render();
                    this.updateInfo();
                    requestAnimationFrame(render);
                };
                render();
            }

            // æ›´æ–°
            update() {
                this.entityManager.update(16);
                this.fireSystem.update(16);
            }

            // æ¸²æŸ“
            render() {
                // æ¸…ç©ºç”»å¸ƒ
                this.ctx.fillStyle = '#111';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                
                // ç»˜åˆ¶ç½‘æ ¼
                this.drawGrid();
                
                // ç»˜åˆ¶å‘å°„å™¨
                this.drawLauncher();
                
                // ç»˜åˆ¶ç„å‡†çº¿
                this.drawAimLine();
                
                // æ¸²æŸ“æ‰€æœ‰å®ä½“
                this.entityManager.render(this.ctx);
            }

            // ç»˜åˆ¶ç½‘æ ¼
            drawGrid() {
                this.ctx.strokeStyle = '#333';
                this.ctx.lineWidth = 1;
                
                const gridSize = 50;
                for (let x = 0; x < this.canvas.width; x += gridSize) {
                    this.ctx.beginPath();
                    this.ctx.moveTo(x, 0);
                    this.ctx.lineTo(x, this.canvas.height);
                    this.ctx.stroke();
                }
                
                for (let y = 0; y < this.canvas.height; y += gridSize) {
                    this.ctx.beginPath();
                    this.ctx.moveTo(0, y);
                    this.ctx.lineTo(this.canvas.width, y);
                    this.ctx.stroke();
                }
            }

            // ç»˜åˆ¶å‘å°„å™¨
            drawLauncher() {
                const x = this.canvas.width / 2;
                const y = this.canvas.height - 50;
                
                this.ctx.fillStyle = '#4CAF50';
                this.ctx.fillRect(x - 15, y - 15, 30, 30);
                
                this.ctx.fillStyle = '#2E7D32';
                this.ctx.fillRect(x - 10, y - 10, 20, 20);
            }

            // ç»˜åˆ¶ç„å‡†çº¿
            drawAimLine() {
                const startX = this.canvas.width / 2;
                const startY = this.canvas.height - 50;
                
                this.ctx.strokeStyle = '#FF0000';
                this.ctx.lineWidth = 1;
                this.ctx.setLineDash([5, 5]);
                
                this.ctx.beginPath();
                this.ctx.moveTo(startX, startY);
                this.ctx.lineTo(this.mousePos.x, this.mousePos.y);
                this.ctx.stroke();
                
                this.ctx.setLineDash([]);
            }

            // æ›´æ–°ä¿¡æ¯æ˜¾ç¤º
            updateInfo() {
                const fireStats = this.fireSystem.getStats();
                const explosions = this.entityManager.getEntitiesByTag('explosion');
                
                document.getElementById('activeBullets').textContent = fireStats.activeBullets;
                document.getElementById('pooledBullets').textContent = fireStats.pooledBullets;
                document.getElementById('explosions').textContent = explosions.length;
            }
        }

        // å…¨å±€æµ‹è¯•ç®¡ç†å™¨
        let testManager;

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            testManager = new BulletTestManager();
            console.log('ğŸ’¥ å­å¼¹æµ‹è¯•ç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆ');
        });

        // æµ‹è¯•å‡½æ•°
        function testBulletCreation() {
            try {
                const bulletData = {
                    x: 100,
                    y: 100,
                    velocityX: 100,
                    velocityY: 0,
                    type: BulletSystem.BulletType.NORMAL
                };
                
                const bullet = testManager.fireSystem.createBullet(bulletData);
                
                const hasBulletComponent = bullet.hasComponent('Bullet');
                const hasRenderer = bullet.hasComponent('BulletRenderer');
                const hasTransform = bullet.hasComponent('Transform');
                const hasMovement = bullet.hasComponent('Movement');
                
                const passed = hasBulletComponent && hasRenderer && hasTransform && hasMovement;
                testManager.addResult('å­å¼¹åˆ›å»ºæµ‹è¯•', passed, 
                    passed ? 'å­å¼¹ç»„ä»¶åˆ›å»ºå®Œæ•´' : 'å­å¼¹ç»„ä»¶ç¼ºå¤±');
                return passed;
            } catch (error) {
                testManager.addResult('å­å¼¹åˆ›å»ºæµ‹è¯•', false, `é”™è¯¯: ${error.message}`);
                return false;
            }
        }

        function testBulletTypes() {
            try {
                const types = [
                    BulletSystem.BulletType.NORMAL,
                    BulletSystem.BulletType.ARMOR_PIERCING,
                    BulletSystem.BulletType.EXPLOSIVE,
                    BulletSystem.BulletType.LASER,
                    BulletSystem.BulletType.PLASMA
                ];
                
                let allConfigsExist = true;
                for (const type of types) {
                    if (!BulletSystem.BulletConfig[type]) {
                        allConfigsExist = false;
                        break;
                    }
                }
                
                const passed = allConfigsExist && types.length === 5;
                testManager.addResult('å­å¼¹ç±»å‹æµ‹è¯•', passed,
                    passed ? 'æ‰€æœ‰å­å¼¹ç±»å‹é…ç½®å®Œæ•´' : 'å­å¼¹ç±»å‹é…ç½®ç¼ºå¤±');
                return passed;
            } catch (error) {
                testManager.addResult('å­å¼¹ç±»å‹æµ‹è¯•', false, `é”™è¯¯: ${error.message}`);
                return false;
            }
        }

        function testFireSystem() {
            try {
                const fireSystem = new BulletSystem.FireSystem();
                
                const bulletData = {
                    x: 0, y: 0, velocityX: 100, velocityY: 0,
                    type: BulletSystem.BulletType.NORMAL
                };
                
                const bullet1 = fireSystem.createBullet(bulletData);
                const bullet2 = fireSystem.createBullet(bulletData);
                
                const stats = fireSystem.getStats();
                const correctStats = stats.activeBullets === 2;
                
                const passed = bullet1 && bullet2 && correctStats;
                testManager.addResult('å°„å‡»ç³»ç»Ÿæµ‹è¯•', passed,
                    passed ? 'å°„å‡»ç³»ç»ŸåŠŸèƒ½æ­£å¸¸' : 'å°„å‡»ç³»ç»ŸåŠŸèƒ½å¼‚å¸¸');
                return passed;
            } catch (error) {
                testManager.addResult('å°„å‡»ç³»ç»Ÿæµ‹è¯•', false, `é”™è¯¯: ${error.message}`);
                return false;
            }
        }

        function testBulletComponent() {
            try {
                const bullet = new BulletSystem.Bullet(BulletSystem.BulletType.EXPLOSIVE);
                
                const hasConfig = bullet.config !== null;
                const correctDamage = bullet.damage === bullet.config.damage;
                const correctRange = bullet.range === bullet.config.range;
                const isExplosive = bullet.config.explosive === true;
                
                const passed = hasConfig && correctDamage && correctRange && isExplosive;
                testManager.addResult('å­å¼¹ç»„ä»¶æµ‹è¯•', passed,
                    passed ? 'å­å¼¹ç»„ä»¶é…ç½®æ­£ç¡®' : 'å­å¼¹ç»„ä»¶é…ç½®é”™è¯¯');
                return passed;
            } catch (error) {
                testManager.addResult('å­å¼¹ç»„ä»¶æµ‹è¯•', false, `é”™è¯¯: ${error.message}`);
                return false;
            }
        }

        function testExplosion() {
            try {
                const explosion = new BulletSystem.Explosion(50, 1000);
                
                const hasRadius = explosion.radius === 50;
                const hasDuration = explosion.duration === 1000;
                const hasParticles = explosion.particles.length > 0;
                
                const passed = hasRadius && hasDuration && hasParticles;
                testManager.addResult('çˆ†ç‚¸æ•ˆæœæµ‹è¯•', passed,
                    passed ? 'çˆ†ç‚¸æ•ˆæœåˆ›å»ºæ­£ç¡®' : 'çˆ†ç‚¸æ•ˆæœåˆ›å»ºé”™è¯¯');
                return passed;
            } catch (error) {
                testManager.addResult('çˆ†ç‚¸æ•ˆæœæµ‹è¯•', false, `é”™è¯¯: ${error.message}`);
                return false;
            }
        }

        function testBulletRenderer() {
            try {
                const renderer = new BulletSystem.BulletRenderer(BulletSystem.BulletType.LASER);
                
                const hasConfig = renderer.config !== null;
                const correctType = renderer.bulletType === BulletSystem.BulletType.LASER;
                const correctColor = renderer.color === '#FF0000';
                
                const passed = hasConfig && correctType && correctColor;
                testManager.addResult('å­å¼¹æ¸²æŸ“å™¨æµ‹è¯•', passed,
                    passed ? 'å­å¼¹æ¸²æŸ“å™¨é…ç½®æ­£ç¡®' : 'å­å¼¹æ¸²æŸ“å™¨é…ç½®é”™è¯¯');
                return passed;
            } catch (error) {
                testManager.addResult('å­å¼¹æ¸²æŸ“å™¨æµ‹è¯•', false, `é”™è¯¯: ${error.message}`);
                return false;
            }
        }

        // è¿è¡Œæ‰€æœ‰æµ‹è¯•
        function runAllTests() {
            testManager.clearResults();
            
            const tests = [
                testBulletCreation,
                testBulletTypes,
                testFireSystem,
                testBulletComponent,
                testExplosion,
                testBulletRenderer
            ];
            
            let passedCount = 0;
            tests.forEach(test => {
                if (test()) passedCount++;
            });
            
            const allPassed = passedCount === tests.length;
            testManager.addResult('æ€»ä½“æµ‹è¯•ç»“æœ', allPassed,
                `${passedCount}/${tests.length} ä¸ªæµ‹è¯•é€šè¿‡`);
            
            console.log(`ğŸ’¥ å­å¼¹ç³»ç»Ÿæµ‹è¯•å®Œæˆ: ${passedCount}/${tests.length} é€šè¿‡`);
        }

        // æ¸…é™¤ç»“æœ
        function clearResults() {
            testManager.clearResults();
        }

        // å‘å°„å­å¼¹
        function fireBullet(type) {
            const startX = testManager.canvas.width / 2;
            const startY = testManager.canvas.height - 50;
            
            const angle = Math.random() * Math.PI * 2;
            const speed = 300;
            
            testManager.createBullet({
                x: startX,
                y: startY,
                velocityX: Math.cos(angle) * speed,
                velocityY: Math.sin(angle) * speed,
                type: BulletSystem.BulletType[type.toUpperCase()]
            });
            
            console.log('ğŸ’¥ å‘å°„å­å¼¹:', type);
        }

        // åˆ›å»ºçˆ†ç‚¸
        function createExplosion() {
            const x = Math.random() * testManager.canvas.width;
            const y = Math.random() * testManager.canvas.height;
            const radius = 30 + Math.random() * 50;
            
            testManager.createExplosion(x, y, radius);
            console.log('ğŸ’¥ åˆ›å»ºçˆ†ç‚¸æ•ˆæœ');
        }

        // æµ‹è¯•ç©¿é€
        function testPenetration() {
            const startX = testManager.canvas.width / 2;
            const startY = testManager.canvas.height - 50;
            
            // å‘å°„ç©¿ç”²å¼¹
            testManager.createBullet({
                x: startX,
                y: startY,
                velocityX: 0,
                velocityY: -300,
                type: BulletSystem.BulletType.ARMOR_PIERCING
            });
            
            console.log('ğŸ¯ æµ‹è¯•ç©¿ç”²å¼¹ç©¿é€');
        }

        // æµ‹è¯•è½¨è¿¹
        function testTrail() {
            const startX = testManager.canvas.width / 2;
            const startY = testManager.canvas.height - 50;
            
            // å‘å°„ç­‰ç¦»å­å¼¹ï¼ˆæœ‰è½¨è¿¹ï¼‰
            testManager.createBullet({
                x: startX,
                y: startY,
                velocityX: 200,
                velocityY: -200,
                type: BulletSystem.BulletType.PLASMA
            });
            
            console.log('âœ¨ æµ‹è¯•å­å¼¹è½¨è¿¹');
        }

        // æ¸…é™¤å­å¼¹
        function clearBullets() {
            testManager.fireSystem.clearAll();
            
            // æ¸…é™¤çˆ†ç‚¸æ•ˆæœ
            const explosions = testManager.entityManager.getEntitiesByTag('explosion');
            explosions.forEach(explosion => {
                testManager.entityManager.removeEntity(explosion);
            });
            
            console.log('ğŸ§¹ æ¸…é™¤æ‰€æœ‰å­å¼¹å’Œæ•ˆæœ');
        }
    </script>
</body>
</html>