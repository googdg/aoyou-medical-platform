<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®ä½“ç»„ä»¶ç³»ç»Ÿæµ‹è¯• - ECS Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f0f0f0;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .test-pass {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .test-fail {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .test-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        #testCanvas {
            border: 2px solid #333;
            background: #000;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª å®ä½“ç»„ä»¶ç³»ç»Ÿæµ‹è¯•</h1>
    
    <div class="test-container">
        <h2>ğŸ“‹ æµ‹è¯•ç»“æœ</h2>
        <div id="testResults"></div>
        <button onclick="runAllTests()">ğŸš€ è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
        <button onclick="clearResults()">ğŸ§¹ æ¸…é™¤ç»“æœ</button>
    </div>

    <div class="test-container">
        <h2>ğŸ® å¯è§†åŒ–æµ‹è¯•</h2>
        <canvas id="testCanvas" width="400" height="300"></canvas>
        <br>
        <button onclick="createTestEntity()">â• åˆ›å»ºå®ä½“</button>
        <button onclick="removeTestEntity()">â– ç§»é™¤å®ä½“</button>
        <button onclick="testCollision()">ğŸ’¥ æµ‹è¯•ç¢°æ’</button>
        <button onclick="clearCanvas()">ğŸ§¹ æ¸…é™¤ç”»å¸ƒ</button>
    </div>

    <div class="test-container">
        <h2>ğŸ“Š å®æ—¶ä¿¡æ¯</h2>
        <div id="liveInfo">
            <p>å®ä½“æ•°é‡: <span id="entityCount">0</span></p>
            <p>ç»„ä»¶æ€»æ•°: <span id="componentCount">0</span></p>
            <p>ç¢°æ’æ£€æµ‹: <span id="collisionInfo">æ— </span></p>
        </div>
    </div>

    <!-- å¼•å…¥å®ä½“ç»„ä»¶ç³»ç»Ÿ -->
    <script src="../js/entity-component-system.js"></script>
    
    <script>
        // æµ‹è¯•ç®¡ç†å™¨
        class TestManager {
            constructor() {
                this.results = [];
                this.entityManager = new ECS.EntityManager();
                this.collisionSystem = new ECS.CollisionSystem(this.entityManager);
                this.canvas = document.getElementById('testCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.testEntities = [];
                
                this.startRenderLoop();
            }

            // æ·»åŠ æµ‹è¯•ç»“æœ
            addResult(testName, passed, message = '') {
                this.results.push({
                    name: testName,
                    passed: passed,
                    message: message,
                    timestamp: new Date().toLocaleTimeString()
                });
                this.updateResultsDisplay();
            }

            // æ›´æ–°ç»“æœæ˜¾ç¤º
            updateResultsDisplay() {
                const container = document.getElementById('testResults');
                container.innerHTML = '';
                
                this.results.forEach(result => {
                    const div = document.createElement('div');
                    div.className = `test-result ${result.passed ? 'test-pass' : 'test-fail'}`;
                    div.innerHTML = `
                        <strong>${result.passed ? 'âœ…' : 'âŒ'} ${result.name}</strong>
                        <br><small>${result.timestamp}</small>
                        ${result.message ? `<br>${result.message}` : ''}
                    `;
                    container.appendChild(div);
                });
            }

            // æ¸…é™¤ç»“æœ
            clearResults() {
                this.results = [];
                this.updateResultsDisplay();
            }

            // å¼€å§‹æ¸²æŸ“å¾ªç¯
            startRenderLoop() {
                const render = () => {
                    this.update();
                    this.render();
                    this.updateLiveInfo();
                    requestAnimationFrame(render);
                };
                render();
            }

            // æ›´æ–°
            update() {
                this.entityManager.update(16);
                this.collisionSystem.update();
            }

            // æ¸²æŸ“
            render() {
                // æ¸…ç©ºç”»å¸ƒ
                this.ctx.fillStyle = '#000';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                
                // æ¸²æŸ“æ‰€æœ‰å®ä½“
                this.entityManager.render(this.ctx);
            }

            // æ›´æ–°å®æ—¶ä¿¡æ¯
            updateLiveInfo() {
                document.getElementById('entityCount').textContent = this.entityManager.getEntityCount();
                
                let componentCount = 0;
                for (const entity of this.entityManager.entities.values()) {
                    componentCount += entity.components.size;
                }
                document.getElementById('componentCount').textContent = componentCount;
                
                const collisionPairs = this.collisionSystem.getCollisionPairs();
                document.getElementById('collisionInfo').textContent = 
                    collisionPairs.length > 0 ? `${collisionPairs.length} ä¸ªç¢°æ’å¯¹` : 'æ— ç¢°æ’';
            }
        }

        // å…¨å±€æµ‹è¯•ç®¡ç†å™¨
        let testManager;

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            testManager = new TestManager();
            console.log('ğŸ§ª æµ‹è¯•ç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆ');
        });

        // æµ‹è¯•å‡½æ•°
        function testEntityCreation() {
            try {
                const entity = new ECS.Entity('TestEntity');
                const passed = entity.id && entity.name === 'TestEntity' && entity.components.size === 0;
                testManager.addResult('å®ä½“åˆ›å»ºæµ‹è¯•', passed, 
                    passed ? 'å®ä½“åˆ›å»ºæˆåŠŸ' : 'å®ä½“åˆ›å»ºå¤±è´¥');
                return passed;
            } catch (error) {
                testManager.addResult('å®ä½“åˆ›å»ºæµ‹è¯•', false, `é”™è¯¯: ${error.message}`);
                return false;
            }
        }

        function testComponentSystem() {
            try {
                const entity = new ECS.Entity('ComponentTest');
                const transform = new ECS.Transform(100, 100);
                const renderer = new ECS.Renderer(null, 32, 32, '#FF0000');
                
                entity.addComponent(transform);
                entity.addComponent(renderer);
                
                const hasTransform = entity.hasComponent('Transform');
                const hasRenderer = entity.hasComponent('Renderer');
                const retrievedTransform = entity.getComponent('Transform');
                
                const passed = hasTransform && hasRenderer && 
                              retrievedTransform === transform &&
                              entity.components.size === 2;
                
                testManager.addResult('ç»„ä»¶ç³»ç»Ÿæµ‹è¯•', passed,
                    passed ? 'ç»„ä»¶æ·»åŠ å’Œè·å–æˆåŠŸ' : 'ç»„ä»¶ç³»ç»Ÿæµ‹è¯•å¤±è´¥');
                return passed;
            } catch (error) {
                testManager.addResult('ç»„ä»¶ç³»ç»Ÿæµ‹è¯•', false, `é”™è¯¯: ${error.message}`);
                return false;
            }
        }

        function testTransformComponent() {
            try {
                const transform = new ECS.Transform(50, 75, Math.PI / 4);
                
                // æµ‹è¯•ä½ç½®è®¾ç½®
                transform.setPosition(100, 200);
                const positionCorrect = transform.x === 100 && transform.y === 200;
                
                // æµ‹è¯•æ—‹è½¬
                transform.setRotationDegrees(90);
                const rotationCorrect = Math.abs(transform.rotation - Math.PI / 2) < 0.001;
                
                // æµ‹è¯•ç§»åŠ¨
                transform.translate(10, 20);
                const translateCorrect = transform.x === 110 && transform.y === 220;
                
                const passed = positionCorrect && rotationCorrect && translateCorrect;
                testManager.addResult('Transformç»„ä»¶æµ‹è¯•', passed,
                    passed ? 'ä½ç½®ã€æ—‹è½¬ã€ç§»åŠ¨åŠŸèƒ½æ­£å¸¸' : 'Transformç»„ä»¶åŠŸèƒ½å¼‚å¸¸');
                return passed;
            } catch (error) {
                testManager.addResult('Transformç»„ä»¶æµ‹è¯•', false, `é”™è¯¯: ${error.message}`);
                return false;
            }
        }

        function testCollisionDetection() {
            try {
                const entity1 = new ECS.Entity('Collider1');
                const entity2 = new ECS.Entity('Collider2');
                
                entity1.addComponent(new ECS.Transform(100, 100));
                entity1.addComponent(new ECS.Collider(32, 32));
                
                entity2.addComponent(new ECS.Transform(110, 110));
                entity2.addComponent(new ECS.Collider(32, 32));
                
                const collider1 = entity1.getComponent('Collider');
                const collider2 = entity2.getComponent('Collider');
                
                const collision = collider1.checkCollision(collider2);
                
                // æµ‹è¯•æ— ç¢°æ’æƒ…å†µ
                entity2.getComponent('Transform').setPosition(200, 200);
                const noCollision = !collider1.checkCollision(collider2);
                
                const passed = collision && noCollision;
                testManager.addResult('ç¢°æ’æ£€æµ‹æµ‹è¯•', passed,
                    passed ? 'ç¢°æ’æ£€æµ‹åŠŸèƒ½æ­£å¸¸' : 'ç¢°æ’æ£€æµ‹åŠŸèƒ½å¼‚å¸¸');
                return passed;
            } catch (error) {
                testManager.addResult('ç¢°æ’æ£€æµ‹æµ‹è¯•', false, `é”™è¯¯: ${error.message}`);
                return false;
            }
        }

        function testMovementComponent() {
            try {
                const entity = new ECS.Entity('MovementTest');
                const transform = new ECS.Transform(100, 100);
                const movement = new ECS.Movement(200);
                
                entity.addComponent(transform);
                entity.addComponent(movement);
                
                // è®¾ç½®é€Ÿåº¦
                movement.setVelocity(100, 0);
                
                // æ¨¡æ‹Ÿæ›´æ–°
                movement.update(100); // 0.1ç§’
                
                // æ£€æŸ¥ä½ç½®æ˜¯å¦æ”¹å˜
                const moved = transform.x !== 100;
                
                const passed = moved;
                testManager.addResult('Movementç»„ä»¶æµ‹è¯•', passed,
                    passed ? 'ç§»åŠ¨ç»„ä»¶åŠŸèƒ½æ­£å¸¸' : 'ç§»åŠ¨ç»„ä»¶åŠŸèƒ½å¼‚å¸¸');
                return passed;
            } catch (error) {
                testManager.addResult('Movementç»„ä»¶æµ‹è¯•', false, `é”™è¯¯: ${error.message}`);
                return false;
            }
        }

        function testEntityManager() {
            try {
                const manager = new ECS.EntityManager();
                const entity1 = new ECS.Entity('Entity1');
                const entity2 = new ECS.Entity('Entity2');
                
                entity1.addTag('player');
                entity2.addTag('enemy');
                
                manager.addEntity(entity1);
                manager.addEntity(entity2);
                
                // æ›´æ–°ç®¡ç†å™¨ä»¥å¤„ç†å¾…æ·»åŠ çš„å®ä½“
                manager.update(16);
                
                const countCorrect = manager.getEntityCount() === 2;
                const retrieveById = manager.getEntity(entity1.id) === entity1;
                const retrieveByName = manager.getEntityByName('Entity1') === entity1;
                const retrieveByTag = manager.getEntitiesByTag('player').includes(entity1);
                
                const passed = countCorrect && retrieveById && retrieveByName && retrieveByTag;
                testManager.addResult('EntityManageræµ‹è¯•', passed,
                    passed ? 'å®ä½“ç®¡ç†å™¨åŠŸèƒ½æ­£å¸¸' : 'å®ä½“ç®¡ç†å™¨åŠŸèƒ½å¼‚å¸¸');
                return passed;
            } catch (error) {
                testManager.addResult('EntityManageræµ‹è¯•', false, `é”™è¯¯: ${error.message}`);
                return false;
            }
        }

        // è¿è¡Œæ‰€æœ‰æµ‹è¯•
        function runAllTests() {
            testManager.clearResults();
            
            const tests = [
                testEntityCreation,
                testComponentSystem,
                testTransformComponent,
                testCollisionDetection,
                testMovementComponent,
                testEntityManager
            ];
            
            let passedCount = 0;
            tests.forEach(test => {
                if (test()) passedCount++;
            });
            
            const allPassed = passedCount === tests.length;
            testManager.addResult('æ€»ä½“æµ‹è¯•ç»“æœ', allPassed,
                `${passedCount}/${tests.length} ä¸ªæµ‹è¯•é€šè¿‡`);
            
            console.log(`ğŸ§ª æµ‹è¯•å®Œæˆ: ${passedCount}/${tests.length} é€šè¿‡`);
        }

        // æ¸…é™¤ç»“æœ
        function clearResults() {
            testManager.clearResults();
        }

        // åˆ›å»ºæµ‹è¯•å®ä½“
        function createTestEntity() {
            const entity = new ECS.Entity('VisualTest');
            
            const x = Math.random() * (testManager.canvas.width - 32) + 16;
            const y = Math.random() * (testManager.canvas.height - 32) + 16;
            
            entity.addComponent(new ECS.Transform(x, y));
            entity.addComponent(new ECS.Renderer(null, 32, 32, 
                `hsl(${Math.random() * 360}, 70%, 50%)`));
            entity.addComponent(new ECS.Collider(32, 32));
            
            const movement = new ECS.Movement(50);
            movement.setVelocity(
                (Math.random() - 0.5) * 100,
                (Math.random() - 0.5) * 100
            );
            entity.addComponent(movement);
            
            entity.addTag('visual-test');
            
            testManager.entityManager.addEntity(entity);
            testManager.testEntities.push(entity);
            
            console.log('â• åˆ›å»ºæµ‹è¯•å®ä½“:', entity.id);
        }

        // ç§»é™¤æµ‹è¯•å®ä½“
        function removeTestEntity() {
            if (testManager.testEntities.length > 0) {
                const entity = testManager.testEntities.pop();
                testManager.entityManager.removeEntity(entity);
                console.log('â– ç§»é™¤æµ‹è¯•å®ä½“:', entity.id);
            }
        }

        // æµ‹è¯•ç¢°æ’
        function testCollision() {
            const entities = testManager.entityManager.getEntitiesByTag('visual-test');
            if (entities.length < 2) {
                alert('éœ€è¦è‡³å°‘2ä¸ªå®ä½“æ¥æµ‹è¯•ç¢°æ’');
                return;
            }
            
            // å°†å‰ä¸¤ä¸ªå®ä½“ç§»åŠ¨åˆ°ç›¸è¿‘ä½ç½®
            const entity1 = entities[0];
            const entity2 = entities[1];
            
            const transform1 = entity1.getComponent('Transform');
            const transform2 = entity2.getComponent('Transform');
            
            if (transform1 && transform2) {
                transform2.setPosition(transform1.x + 20, transform1.y + 20);
                console.log('ğŸ’¥ å¼ºåˆ¶ç¢°æ’æµ‹è¯•');
            }
        }

        // æ¸…é™¤ç”»å¸ƒ
        function clearCanvas() {
            const entities = testManager.entityManager.getEntitiesByTag('visual-test');
            entities.forEach(entity => {
                testManager.entityManager.removeEntity(entity);
            });
            testManager.testEntities = [];
            console.log('ğŸ§¹ æ¸…é™¤æ‰€æœ‰å¯è§†åŒ–æµ‹è¯•å®ä½“');
        }
    </script>
</body>
</html>