<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é“å…·ç³»ç»Ÿæµ‹è¯• - å¦å…‹å¤§æˆ˜</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background-color: #1a1a1a;
            color: #ffffff;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .test-section {
            background-color: #2a2a2a;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        button {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        button:hover {
            background-color: #45a049;
        }
        
        button:disabled {
            background-color: #666;
            cursor: not-allowed;
        }
        
        .danger { background-color: #f44336; }
        .danger:hover { background-color: #da190b; }
        
        .warning { background-color: #ff9800; }
        .warning:hover { background-color: #e68900; }
        
        .info { background-color: #2196F3; }
        .info:hover { background-color: #1976D2; }
        
        canvas {
            border: 2px solid #444;
            background-color: #000;
            display: block;
            margin: 0 auto;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-card {
            background-color: #333;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #4CAF50;
        }
        
        .stat-label {
            font-size: 12px;
            color: #ccc;
            margin-top: 5px;
        }
        
        .powerup-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .powerup-card {
            background-color: #333;
            border-radius: 6px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .powerup-card:hover {
            background-color: #444;
            transform: translateY(-2px);
        }
        
        .powerup-card.common { border-color: #808080; }
        .powerup-card.uncommon { border-color: #00ff00; }
        .powerup-card.rare { border-color: #0080ff; }
        .powerup-card.epic { border-color: #8000ff; }
        .powerup-card.legendary { border-color: #ffd700; }
        
        .powerup-icon {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .powerup-name {
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 3px;
        }
        
        .powerup-rarity {
            font-size: 10px;
            opacity: 0.7;
        }
        
        .effects-panel {
            background-color: #1a1a2e;
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .effect-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin: 5px 0;
            background-color: #16213e;
            border-radius: 4px;
        }
        
        .effect-name {
            font-weight: bold;
        }
        
        .effect-timer {
            font-size: 12px;
            color: #ffd700;
        }
        
        .progress-bar {
            width: 100px;
            height: 4px;
            background-color: #333;
            border-radius: 2px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background-color: #4CAF50;
            transition: width 0.3s ease;
        }
        
        .log {
            background-color: #000;
            color: #0f0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            padding: 10px;
            height: 200px;
            overflow-y: auto;
            border: 1px solid #333;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>âœ¨ é“å…·ç³»ç»Ÿæµ‹è¯•</h1>
            <p>æµ‹è¯•å¦å…‹å¤§æˆ˜æ¸¸æˆçš„é“å…·å’Œæ­¦å™¨å‡çº§ç³»ç»Ÿ</p>
        </div>

        <div class="test-section">
            <h2>ğŸ® æ¸¸æˆæ§åˆ¶</h2>
            <div class="controls">
                <button id="startTest">å¼€å§‹æµ‹è¯•</button>
                <button id="pauseTest">æš‚åœ/ç»§ç»­</button>
                <button id="resetTest" class="warning">é‡ç½®æµ‹è¯•</button>
                <button id="stopTest" class="danger">åœæ­¢æµ‹è¯•</button>
            </div>
            
            <div class="controls">
                <button id="spawnRandomPowerUp" class="info">ç”Ÿæˆéšæœºé“å…·</button>
                <button id="clearPowerUps" class="warning">æ¸…é™¤æ‰€æœ‰é“å…·</button>
                <button id="giveAllEffects" class="info">è·å¾—æ‰€æœ‰æ•ˆæœ</button>
                <button id="clearEffects" class="warning">æ¸…é™¤æ‰€æœ‰æ•ˆæœ</button>
            </div>
        </div>

        <div class="test-section">
            <h2>ğŸ¯ æ¸¸æˆç”»é¢</h2>
            <canvas id="gameCanvas" width="800" height="600"></canvas>
            <div class="controls">
                <p>ä½¿ç”¨ WASD ç§»åŠ¨å¦å…‹ï¼Œç©ºæ ¼é”®å°„å‡»ï¼Œé è¿‘é“å…·è‡ªåŠ¨æ”¶é›†</p>
            </div>
        </div>

        <div class="test-section">
            <h2>ğŸ“Š é“å…·ç»Ÿè®¡</h2>
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-value" id="totalSpawned">0</div>
                    <div class="stat-label">æ€»ç”Ÿæˆæ•°é‡</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalCollected">0</div>
                    <div class="stat-label">æ€»æ”¶é›†æ•°é‡</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="activePowerUps">0</div>
                    <div class="stat-label">åœºæ™¯ä¸­é“å…·</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="activeEffects">0</div>
                    <div class="stat-label">æ¿€æ´»æ•ˆæœ</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="weaponLevel">0</div>
                    <div class="stat-label">æ­¦å™¨ç­‰çº§</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="collectionRate">0%</div>
                    <div class="stat-label">æ”¶é›†æˆåŠŸç‡</div>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h2>ğŸ é“å…·ç±»å‹</h2>
            <p>ç‚¹å‡»é“å…·å¡ç‰‡å¯ä»¥ç›´æ¥ç”Ÿæˆè¯¥é“å…·</p>
            <div id="powerUpGrid" class="powerup-grid">
                <!-- é“å…·å¡ç‰‡å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>

        <div class="test-section">
            <h2>âš¡ å½“å‰æ•ˆæœ</h2>
            <div id="effectsPanel" class="effects-panel">
                <p>å½“å‰æ²¡æœ‰æ¿€æ´»çš„é“å…·æ•ˆæœ</p>
            </div>
        </div>

        <div class="test-section">
            <h2>ğŸ“ ç³»ç»Ÿæ—¥å¿—</h2>
            <div class="controls">
                <button id="clearLog" class="warning">æ¸…é™¤æ—¥å¿—</button>
                <button id="exportLog" class="info">å¯¼å‡ºæ—¥å¿—</button>
            </div>
            <div id="systemLog" class="log"></div>
        </div>
    </div>

    <!-- å¼•å…¥ä¾èµ– -->
    <script src="../js/entity-component-system.js"></script>
    <script src="../js/map-system.js"></script>
    <script src="../js/tank-system.js"></script>
    <script src="../js/powerup-system.js"></script>

    <script>
        // é“å…·ç³»ç»Ÿæµ‹è¯•ç±»
        class PowerUpSystemTest {
            constructor() {
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.isRunning = false;
                this.isPaused = false;
                
                // æ¸¸æˆç³»ç»Ÿ
                this.entityManager = new EntityManager();
                this.gameMap = null;
                this.powerUpManager = null;
                this.weaponUpgradeSystem = new PowerUpSystem.WeaponUpgradeSystem();
                this.playerTank = null;
                
                // è¾“å…¥å¤„ç†
                this.keys = new Set();
                
                this.lastTime = 0;
                
                this.initializeUI();
                this.initializeGame();
                this.setupInputHandlers();
            }

            initializeUI() {
                // ç»‘å®šæ§åˆ¶æŒ‰é’®
                document.getElementById('startTest').addEventListener('click', () => this.startTest());
                document.getElementById('pauseTest').addEventListener('click', () => this.togglePause());
                document.getElementById('resetTest').addEventListener('click', () => this.resetTest());
                document.getElementById('stopTest').addEventListener('click', () => this.stopTest());
                
                document.getElementById('spawnRandomPowerUp').addEventListener('click', () => this.spawnRandomPowerUp());
                document.getElementById('clearPowerUps').addEventListener('click', () => this.clearPowerUps());
                document.getElementById('giveAllEffects').addEventListener('click', () => this.giveAllEffects());
                document.getElementById('clearEffects').addEventListener('click', () => this.clearEffects());
                
                document.getElementById('clearLog').addEventListener('click', () => this.clearLog());
                document.getElementById('exportLog').addEventListener('click', () => this.exportLog());
                
                // ç”Ÿæˆé“å…·å¡ç‰‡
                this.generatePowerUpCards();
                
                this.log('é“å…·ç³»ç»Ÿæµ‹è¯•åˆå§‹åŒ–å®Œæˆ');
            }

            generatePowerUpCards() {
                const grid = document.getElementById('powerUpGrid');
                
                for (const [type, config] of Object.entries(PowerUpSystem.PowerUpConfig)) {
                    const card = document.createElement('div');
                    card.className = `powerup-card ${config.rarity}`;
                    card.innerHTML = `
                        <div class="powerup-icon">${config.icon}</div>
                        <div class="powerup-name">${config.name}</div>
                        <div class="powerup-rarity">${config.rarity}</div>
                    `;
                    
                    card.addEventListener('click', () => {
                        if (this.isRunning && this.playerTank) {
                            const transform = this.playerTank.getComponent('Transform');
                            if (transform) {
                                // åœ¨ç©å®¶é™„è¿‘ç”Ÿæˆé“å…·
                                const x = transform.x + (Math.random() - 0.5) * 100;
                                const y = transform.y + (Math.random() - 0.5) * 100;
                                this.powerUpManager.forceSpawnPowerUp(type, x, y);
                                this.log(`æ‰‹åŠ¨ç”Ÿæˆé“å…·: ${config.name}`);
                            }
                        }
                    });
                    
                    grid.appendChild(card);
                }
            }

            initializeGame() {
                // åˆ›å»ºæ¸¸æˆåœ°å›¾
                this.gameMap = new GameMap(25, 19, 32);
                this.gameMap.generateRandomMap();
                
                // åˆ›å»ºé“å…·ç®¡ç†å™¨
                this.powerUpManager = new PowerUpSystem.PowerUpManager(this.entityManager, this.gameMap);
                
                // åˆ›å»ºç©å®¶å¦å…‹
                this.createPlayerTank();
                
                this.log('æ¸¸æˆç¯å¢ƒåˆå§‹åŒ–å®Œæˆ');
            }

            createPlayerTank() {
                const playerEntity = this.entityManager.createEntity();
                playerEntity.addTag('player');
                
                // æ·»åŠ ç»„ä»¶
                playerEntity.addComponent(new Transform(400, 300, 0));
                playerEntity.addComponent(new Movement(120));
                playerEntity.addComponent(new Health(100, 100));
                playerEntity.addComponent(new Weapon('normal', 25, 500, 300));
                
                // æ·»åŠ æ¸²æŸ“ç»„ä»¶
                const renderer = new Renderer('#00ff00', 24, 24);
                renderer.shape = 'tank';
                playerEntity.addComponent(renderer);
                
                // æ·»åŠ ç¢°æ’ä½“
                playerEntity.addComponent(new Collider(24, 24, 'player'));
                
                this.playerTank = playerEntity;
                this.log('ç©å®¶å¦å…‹åˆ›å»ºå®Œæˆ');
            }

            setupInputHandlers() {
                document.addEventListener('keydown', (e) => {
                    this.keys.add(e.code);
                });
                
                document.addEventListener('keyup', (e) => {
                    this.keys.delete(e.code);
                });
                
                // ç›‘å¬é“å…·æ”¶é›†äº‹ä»¶
                window.addEventListener('powerUpCollected', (e) => {
                    const { type } = e.detail;
                    const config = PowerUpSystem.PowerUpConfig[type];
                    this.log(`ğŸ æ”¶é›†é“å…·: ${config.name}`);
                    this.updateStats();
                });
            }

            startTest() {
                if (this.isRunning) return;
                
                this.isRunning = true;
                this.isPaused = false;
                
                this.gameLoop();
                this.log('æµ‹è¯•å¼€å§‹');
            }

            togglePause() {
                if (!this.isRunning) return;
                
                this.isPaused = !this.isPaused;
                if (!this.isPaused) {
                    this.gameLoop();
                }
                this.log(this.isPaused ? 'æµ‹è¯•æš‚åœ' : 'æµ‹è¯•ç»§ç»­');
            }

            resetTest() {
                this.stopTest();
                this.powerUpManager.clear();
                this.weaponUpgradeSystem = new PowerUpSystem.WeaponUpgradeSystem();
                
                // é‡ç½®ç©å®¶å¦å…‹
                if (this.playerTank) {
                    const health = this.playerTank.getComponent('Health');
                    const weapon = this.playerTank.getComponent('Weapon');
                    if (health) {
                        health.current = health.max;
                    }
                    if (weapon) {
                        weapon.damage = 25;
                        weapon.fireRate = 500;
                        weapon.range = 300;
                    }
                }
                
                this.updateStats();
                this.log('æµ‹è¯•é‡ç½®');
            }

            stopTest() {
                this.isRunning = false;
                this.isPaused = false;
                this.log('æµ‹è¯•åœæ­¢');
            }

            spawnRandomPowerUp() {
                if (this.powerUpManager) {
                    this.powerUpManager.spawnRandomPowerUp();
                    this.log('ç”Ÿæˆéšæœºé“å…·');
                }
            }

            clearPowerUps() {
                if (this.powerUpManager) {
                    // åªæ¸…é™¤é“å…·ï¼Œä¸æ¸…é™¤æ•ˆæœ
                    for (const [id, entity] of this.powerUpManager.activePowerUps) {
                        this.entityManager.removeEntity(entity);
                    }
                    this.powerUpManager.activePowerUps.clear();
                    this.log('æ¸…é™¤æ‰€æœ‰é“å…·');
                }
            }

            giveAllEffects() {
                if (this.playerTank && this.powerUpManager) {
                    const types = Object.keys(PowerUpSystem.PowerUpType);
                    for (const type of types) {
                        this.powerUpManager.givePlayerEffect(this.playerTank, PowerUpSystem.PowerUpType[type]);
                    }
                    this.log('è·å¾—æ‰€æœ‰é“å…·æ•ˆæœ');
                }
            }

            clearEffects() {
                if (this.powerUpManager) {
                    this.powerUpManager.playerEffects.clear();
                    this.log('æ¸…é™¤æ‰€æœ‰æ•ˆæœ');
                }
            }

            gameLoop(currentTime = 0) {
                if (!this.isRunning || this.isPaused) return;
                
                const deltaTime = currentTime - this.lastTime;
                this.lastTime = currentTime;
                
                // æ›´æ–°æ¸¸æˆé€»è¾‘
                this.update(deltaTime);
                
                // æ¸²æŸ“
                this.render();
                
                // æ›´æ–°UI
                this.updateStats();
                this.updateEffectsPanel();
                
                requestAnimationFrame((time) => this.gameLoop(time));
            }

            update(deltaTime) {
                // å¤„ç†è¾“å…¥
                this.handleInput(deltaTime);
                
                // æ›´æ–°é“å…·ç®¡ç†å™¨
                if (this.powerUpManager) {
                    this.powerUpManager.update(deltaTime);
                }
                
                // æ›´æ–°æ‰€æœ‰å®ä½“
                const entities = this.entityManager.getAllEntities();
                for (const entity of entities) {
                    // æ›´æ–°ç§»åŠ¨
                    const movement = entity.getComponent('Movement');
                    const transform = entity.getComponent('Transform');
                    if (movement && transform) {
                        transform.x += movement.velocity.x * deltaTime / 1000;
                        transform.y += movement.velocity.y * deltaTime / 1000;
                        
                        // è¾¹ç•Œæ£€æŸ¥
                        transform.x = Math.max(12, Math.min(this.canvas.width - 12, transform.x));
                        transform.y = Math.max(12, Math.min(this.canvas.height - 12, transform.y));
                    }
                    
                    // æ›´æ–°é“å…·æ•ˆæœ
                    const powerUpEffect = entity.getComponent('PowerUpEffect');
                    if (powerUpEffect) {
                        powerUpEffect.update(deltaTime);
                    }
                }
            }

            handleInput(deltaTime) {
                if (!this.playerTank) return;
                
                const transform = this.playerTank.getComponent('Transform');
                const movement = this.playerTank.getComponent('Movement');
                
                if (!transform || !movement) return;
                
                // é‡ç½®é€Ÿåº¦
                movement.velocity.x = 0;
                movement.velocity.y = 0;
                
                // è·å–é€Ÿåº¦åŠ æˆ
                let speedMultiplier = 1;
                const speedEffect = this.powerUpManager.playerEffects.get(PowerUpSystem.PowerUpType.SPEED_BOOST);
                if (speedEffect && speedEffect.active) {
                    speedMultiplier = speedEffect.effects.speedMultiplier;
                }
                
                const speed = movement.speed * speedMultiplier;
                
                // å¤„ç†ç§»åŠ¨
                if (this.keys.has('KeyW')) {
                    movement.velocity.y = -speed;
                    transform.rotation = -Math.PI / 2;
                }
                if (this.keys.has('KeyS')) {
                    movement.velocity.y = speed;
                    transform.rotation = Math.PI / 2;
                }
                if (this.keys.has('KeyA')) {
                    movement.velocity.x = -speed;
                    transform.rotation = Math.PI;
                }
                if (this.keys.has('KeyD')) {
                    movement.velocity.x = speed;
                    transform.rotation = 0;
                }
                
                // å¤„ç†å°„å‡»
                if (this.keys.has('Space')) {
                    this.handleShooting();
                }
            }

            handleShooting() {
                // ç®€åŒ–çš„å°„å‡»é€»è¾‘
                const weapon = this.playerTank.getComponent('Weapon');
                if (weapon && Date.now() - (weapon.lastFire || 0) > weapon.fireRate) {
                    weapon.lastFire = Date.now();
                    this.log('ğŸ”« ç©å®¶å°„å‡»');
                    
                    // æ£€æŸ¥å¤šé‡å°„å‡»æ•ˆæœ
                    const multiShotEffect = this.powerUpManager.playerEffects.get(PowerUpSystem.PowerUpType.MULTI_SHOT);
                    if (multiShotEffect && multiShotEffect.active) {
                        this.log('ğŸ† å¤šé‡å°„å‡»æ¿€æ´»');
                    }
                }
            }

            render() {
                // æ¸…ç©ºç”»å¸ƒ
                this.ctx.fillStyle = '#000000';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                
                // æ¸²æŸ“åœ°å›¾
                if (this.gameMap) {
                    this.renderMap();
                }
                
                // æ¸²æŸ“æ‰€æœ‰å®ä½“
                const entities = this.entityManager.getAllEntities();
                for (const entity of entities) {
                    this.renderEntity(entity);
                }
                
                // æ¸²æŸ“é“å…·æ•ˆæœ
                this.renderPowerUpEffects();
            }

            renderMap() {
                const tileSize = this.gameMap.tileSize;
                
                for (let y = 0; y < this.gameMap.height; y++) {
                    for (let x = 0; x < this.gameMap.width; x++) {
                        const tile = this.gameMap.getTile(x, y);
                        const pixelX = x * tileSize;
                        const pixelY = y * tileSize;
                        
                        switch (tile) {
                            case 1: // å¢™å£
                                this.ctx.fillStyle = '#8B4513';
                                this.ctx.fillRect(pixelX, pixelY, tileSize, tileSize);
                                break;
                            case 2: // é’¢å¢™
                                this.ctx.fillStyle = '#696969';
                                this.ctx.fillRect(pixelX, pixelY, tileSize, tileSize);
                                break;
                        }
                    }
                }
            }

            renderEntity(entity) {
                const transform = entity.getComponent('Transform');
                const renderer = entity.getComponent('Renderer');
                
                if (!transform || !renderer) return;
                
                this.ctx.save();
                this.ctx.translate(transform.x, transform.y);
                this.ctx.rotate(transform.rotation);
                
                // æ£€æŸ¥æ— æ•Œæ•ˆæœ
                const invincibilityEffect = this.powerUpManager.playerEffects.get(PowerUpSystem.PowerUpType.INVINCIBILITY);
                if (invincibilityEffect && invincibilityEffect.active && entity === this.playerTank) {
                    // é—ªçƒæ•ˆæœ
                    const alpha = 0.5 + 0.5 * Math.sin(Date.now() * 0.01);
                    this.ctx.globalAlpha = alpha;
                    
                    // å‘å…‰æ•ˆæœ
                    this.ctx.shadowColor = '#FFD700';
                    this.ctx.shadowBlur = 20;
                }
                
                // æ£€æŸ¥éšèº«æ•ˆæœ
                const stealthEffect = this.powerUpManager.playerEffects.get(PowerUpSystem.PowerUpType.STEALTH);
                if (stealthEffect && stealthEffect.active && entity === this.playerTank) {
                    this.ctx.globalAlpha = stealthEffect.effects.transparency;
                }
                
                this.ctx.fillStyle = renderer.color;
                
                if (renderer.shape === 'tank') {
                    // ç»˜åˆ¶å¦å…‹
                    this.ctx.fillRect(-renderer.width/2, -renderer.height/2, 
                                    renderer.width, renderer.height);
                    
                    // ç»˜åˆ¶ç‚®ç®¡
                    this.ctx.fillRect(0, -2, renderer.width/2, 4);
                } else if (renderer.shape === 'powerup') {
                    // ç»˜åˆ¶é“å…·
                    const powerUp = entity.getComponent('PowerUp');
                    if (powerUp) {
                        const scale = powerUp.getPulseScale();
                        const bobOffset = powerUp.getBobOffset();
                        
                        this.ctx.translate(0, bobOffset);
                        this.ctx.scale(scale, scale);
                        
                        // ç»˜åˆ¶é“å…·èƒŒæ™¯
                        this.ctx.fillRect(-renderer.width/2, -renderer.height/2, 
                                        renderer.width, renderer.height);
                        
                        // ç»˜åˆ¶å›¾æ ‡
                        this.ctx.fillStyle = '#ffffff';
                        this.ctx.font = '16px Arial';
                        this.ctx.textAlign = 'center';
                        this.ctx.textBaseline = 'middle';
                        this.ctx.fillText(renderer.icon || '?', 0, 0);
                    }
                } else {
                    // é»˜è®¤çŸ©å½¢
                    this.ctx.fillRect(-renderer.width/2, -renderer.height/2, 
                                    renderer.width, renderer.height);
                }
                
                this.ctx.restore();
            }

            renderPowerUpEffects() {
                if (!this.playerTank) return;
                
                const transform = this.playerTank.getComponent('Transform');
                if (!transform) return;
                
                // æ¸²æŸ“æŠ¤ç›¾æ•ˆæœ
                const shieldEffect = this.powerUpManager.playerEffects.get(PowerUpSystem.PowerUpType.SHIELD);
                if (shieldEffect && shieldEffect.active) {
                    this.ctx.strokeStyle = '#00BFFF';
                    this.ctx.lineWidth = 3;
                    this.ctx.beginPath();
                    this.ctx.arc(transform.x, transform.y, 35, 0, Math.PI * 2);
                    this.ctx.stroke();
                }
                
                // æ¸²æŸ“é›·è¾¾æ•ˆæœ
                const radarEffect = this.powerUpManager.playerEffects.get(PowerUpSystem.PowerUpType.RADAR);
                if (radarEffect && radarEffect.active) {
                    this.ctx.strokeStyle = 'rgba(0, 255, 0, 0.3)';
                    this.ctx.lineWidth = 2;
                    this.ctx.beginPath();
                    this.ctx.arc(transform.x, transform.y, radarEffect.effects.radarRange, 0, Math.PI * 2);
                    this.ctx.stroke();
                }
            }

            updateStats() {
                if (!this.powerUpManager) return;
                
                const stats = this.powerUpManager.getStats();
                
                document.getElementById('totalSpawned').textContent = stats.totalSpawned;
                document.getElementById('totalCollected').textContent = stats.totalCollected;
                document.getElementById('activePowerUps').textContent = stats.activePowerUps;
                document.getElementById('activeEffects').textContent = stats.activeEffects;
                
                const weaponLevel = this.weaponUpgradeSystem.getWeaponLevel(this.playerTank);
                document.getElementById('weaponLevel').textContent = weaponLevel;
                
                const collectionRate = stats.totalSpawned > 0 ? 
                    Math.round((stats.totalCollected / stats.totalSpawned) * 100) : 0;
                document.getElementById('collectionRate').textContent = collectionRate + '%';
            }

            updateEffectsPanel() {
                const panel = document.getElementById('effectsPanel');
                
                if (!this.powerUpManager || this.powerUpManager.playerEffects.size === 0) {
                    panel.innerHTML = '<p>å½“å‰æ²¡æœ‰æ¿€æ´»çš„é“å…·æ•ˆæœ</p>';
                    return;
                }
                
                const effects = this.powerUpManager.getPlayerEffects();
                let html = '';
                
                for (const effect of effects) {
                    const remainingTime = effect.remainingTime;
                    const timeText = remainingTime === Infinity ? 'æ°¸ä¹…' : 
                        `${Math.ceil(remainingTime / 1000)}ç§’`;
                    
                    html += `
                        <div class="effect-item">
                            <div>
                                <span class="effect-name">${effect.config.icon} ${effect.name}</span>
                                ${effect.stacks > 1 ? `<span class="effect-stacks"> x${effect.stacks}</span>` : ''}
                            </div>
                            <div class="effect-timer">${timeText}</div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${(1 - effect.progress) * 100}%"></div>
                            </div>
                        </div>
                    `;
                }
                
                panel.innerHTML = html;
            }

            log(message) {
                const logElement = document.getElementById('systemLog');
                const timestamp = new Date().toLocaleTimeString();
                logElement.innerHTML += `<div>[${timestamp}] ${message}</div>`;
                logElement.scrollTop = logElement.scrollHeight;
            }

            clearLog() {
                document.getElementById('systemLog').innerHTML = '';
            }

            exportLog() {
                const logContent = document.getElementById('systemLog').textContent;
                const blob = new Blob([logContent], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `powerup-test-log-${new Date().toISOString().slice(0, 19)}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
        }

        // å¯åŠ¨æµ‹è¯•
        let powerUpTest;
        window.addEventListener('load', () => {
            powerUpTest = new PowerUpSystemTest();
        });
    </script>
</body>
</html>